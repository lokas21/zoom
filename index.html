<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>YC5 – Expérience</title>

  <!-- jsPsych 7 core -->
  <script src="https://unpkg.com/jspsych@7.3.4/jspsych.js"></script>
  <!-- Plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@1.1.3/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-slider@1.1.3/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3/index.js"></script>
  <!-- jsPsych CSS -->
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet">

  <style>
    /* ---- Fond sombre ---- */
    body { background: #3c3c3c; margin: 0; padding: 0; }
    .jspsych-display-element { background: #3c3c3c; }
    .jspsych-content-wrapper { background: #3c3c3c; }

    /* ---- Croix de fixation ---- */
    .fixation { font-size: 80px; color: #ffffff; }

    /* ---- Modules sliders (Émotion / Situation) ---- */
    .jspsych-survey-slider-preamble { color: #ffffff; font-size: 20px; margin-bottom: 20px; }
    .jspsych-survey-slider-question { color: #ffffff; }
    .jspsych-survey-slider-opt-label { color: #cccccc; }
    .jspsych-survey-slider-response input[type="range"] { width: 600px; }
    .jspsych-btn { background:#555; color:#fff; border:1px solid #aaa; padding:10px 30px;
                   font-size:16px; cursor:pointer; margin-top:20px; border-radius:4px; }
    .jspsych-btn:hover { background:#777; }

    /* ---- Module DAT ---- */
    #dat-container { color: #ffffff; text-align: center; max-width: 1000px; margin: 0 auto; }
    #dat-container .dat-header { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
    #dat-container .dat-subheader { font-size: 15px; margin-bottom: 24px; color: #cccccc; }
    .dat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px 60px;
                justify-items: center; margin-bottom: 20px; }
    .dat-cell { display: flex; flex-direction: column; align-items: center; width: 300px; }
    .dat-cell img { max-width: 280px; max-height: 200px; object-fit: contain;
                    border: 2px solid #888; background: #222; }
    .dat-cell .dat-slider-wrap { width: 260px; margin-top: 12px; }
    .dat-cell input[type="range"] { width: 100%; accent-color: #aaa; }
    .dat-tick-labels { display: flex; justify-content: space-between;
                       font-size: 12px; color: #aaa; margin-top: 2px; }
    #dat-error { color: #ff6666; font-size: 15px; margin-top: 10px; display: none; }

    /* ---- Canvas plein écran ---- */
    canvas { display: block; margin: 0 auto; }
  </style>
</head>
<body>
<script>
"use strict";

/* ==========================================================================
   SECTION 1 — CONFIGURATION  (modifiez ici selon vos fichiers)
   ==========================================================================
   Structure de dossiers attendue :
   ├── YC5_experiment.html      ← ce fichier
   ├── images/
   │   ├── sadness/             ← toutes les images sadness_*.jpg/png
   │   └── hope/                ← toutes les images hope_*.jpg/png
   └── dat_images/
       ├── dat1/                ← dessins pour la dimension DAT 1 (plusieurs fichiers .jpg)
       ├── dat2/
       ├── dat3/
       └── dat4/
*/

const CFG = {
  IMG_BASE    : 'images/',          // chemin relatif vers le dossier images
  ZOOM_FACTOR : 1.5,                // facteur de zoom (ne pas changer sauf si souhaité)
  FIX_MS      : 2000,               // durée fixation (ms)
  IMG_MS      : 8000,               // durée présentation image (ms)
  BG_COLOR    : '#3c3c3c',
};

/* ---------- Dessins DAT : ajoutez autant de fichiers que vous en avez ------
   Pour chaque dimension (dat1..dat4), listez vos fichiers de dessins.
   Un dessin aléatoire est sélectionné par trial, dans un ordre aléatoire
   des 4 dimensions.                                                         */
const DAT_DRAWINGS = {
  dat1 : [ 'dat_images/dat1/drawing_01.jpg', 'dat_images/dat1/drawing_02.jpg' ],
  dat2 : [ 'dat_images/dat2/drawing_01.jpg', 'dat_images/dat2/drawing_02.jpg' ],
  dat3 : [ 'dat_images/dat3/drawing_01.jpg', 'dat_images/dat3/drawing_02.jpg' ],
  dat4 : [ 'dat_images/dat4/drawing_01.jpg', 'dat_images/dat4/drawing_02.jpg' ],
};

/* ==========================================================================
   SECTION 2 — LISTE D'IMAGES  (générée automatiquement depuis emotion_file_8_essais.xlsx)
   ==========================================================================
   Chaque objet : { emotion, image_id, filename, folder, zoomX, zoomY }
   zoomX / zoomY sont en pixels dans l'image originale.                      */

const IMAGE_LIST = [
  {emotion:"sadness",image_id:"sadness_00001.JPG",filename:"sadness_00001.JPG",folder:"sadness",zoomX:1034.8,zoomY:268.07},
  {emotion:"sadness",image_id:"sadness_00005.jpg",filename:"sadness_00005.jpg",folder:"sadness",zoomX:968.76,zoomY:362.42},
  {emotion:"sadness",image_id:"sadness_00009.jpg",filename:"sadness_00009.jpg",folder:"sadness",zoomX:1171.61,zoomY:376.57},
  {emotion:"sadness",image_id:"sadness_00010.jpg",filename:"sadness_00010.jpg",folder:"sadness",zoomX:1072.54,zoomY:617.16},
  {emotion:"sadness",image_id:"sadness_00011.jpg",filename:"sadness_00011.jpg",folder:"sadness",zoomX:655.05,zoomY:454.41},
  {emotion:"sadness",image_id:"sadness_00012.jpg",filename:"sadness_00012.jpg",folder:"sadness",zoomX:1020.65,zoomY:621.88},
  {emotion:"sadness",image_id:"sadness_00016.jpg",filename:"sadness_00016.jpg",folder:"sadness",zoomX:1048.95,zoomY:454.41},
  {emotion:"sadness",image_id:"sadness_00018.jpg",filename:"sadness_00018.jpg",folder:"sadness",zoomX:1025.36,zoomY:390.72},
  {emotion:"sadness",image_id:"sadness_00019.jpg",filename:"sadness_00019.jpg",folder:"sadness",zoomX:881.48,zoomY:428.46},
  {emotion:"sadness",image_id:"sadness_00022.jpg",filename:"sadness_00022.jpg",folder:"sadness",zoomX:973.47,zoomY:473.28},
  {emotion:"sadness",image_id:"sadness_00053.jpg",filename:"sadness_00053.jpg",folder:"sadness",zoomX:982.91,zoomY:428.46},
  {emotion:"sadness",image_id:"sadness_00054.jpg",filename:"sadness_00054.jpg",folder:"sadness",zoomX:770.62,zoomY:614.8},
  {emotion:"sadness",image_id:"sadness_00059.jpg",filename:"sadness_00059.jpg",folder:"sadness",zoomX:1023.01,zoomY:430.82},
  {emotion:"sadness",image_id:"sadness_00063.jpg",filename:"sadness_00063.jpg",folder:"sadness",zoomX:1107.92,zoomY:511.02},
  {emotion:"sadness",image_id:"sadness_00068.jpg",filename:"sadness_00068.jpg",folder:"sadness",zoomX:900.35,zoomY:603.01},
  {emotion:"sadness",image_id:"sadness_00071.jpg",filename:"sadness_00071.jpg",folder:"sadness",zoomX:949.89,zoomY:473.28},
  {emotion:"sadness",image_id:"sadness_00073.jpg",filename:"sadness_00073.jpg",folder:"sadness",zoomX:966.4,zoomY:661.97},
  {emotion:"sadness",image_id:"sadness_00074.jpg",filename:"sadness_00074.jpg",folder:"sadness",zoomX:931.02,zoomY:619.52},
  {emotion:"sadness",image_id:"sadness_00076.jpg",filename:"sadness_00076.jpg",folder:"sadness",zoomX:1204.63,zoomY:544.04},
  {emotion:"sadness",image_id:"sadness_00078.jpg",filename:"sadness_00078.jpg",folder:"sadness",zoomX:879.12,zoomY:496.86},
  {emotion:"sadness",image_id:"sadness_00079.jpg",filename:"sadness_00079.jpg",folder:"sadness",zoomX:961.68,zoomY:619.52},
  {emotion:"sadness",image_id:"sadness_00084.jpg",filename:"sadness_00084.jpg",folder:"sadness",zoomX:905.07,zoomY:598.29},
  {emotion:"sadness",image_id:"sadness_00086.jpg",filename:"sadness_00086.jpg",folder:"sadness",zoomX:902.71,zoomY:480.35},
  {emotion:"sadness",image_id:"sadness_00087.png",filename:"sadness_00087.png",folder:"sadness",zoomX:850.82,zoomY:605.36},
  {emotion:"sadness",image_id:"sadness_00088.png",filename:"sadness_00088.png",folder:"sadness",zoomX:992.34,zoomY:716.22},
  {emotion:"sadness",image_id:"sadness_00089.jpg",filename:"sadness_00089.jpg",folder:"sadness",zoomX:954.6,zoomY:419.03},
  {emotion:"sadness",image_id:"sadness_00091.png",filename:"sadness_00091.png",folder:"sadness",zoomX:824.87,zoomY:527.53},
  {emotion:"sadness",image_id:"sadness_00093.jpg",filename:"sadness_00093.jpg",folder:"sadness",zoomX:940.45,zoomY:695.0},
  {emotion:"sadness",image_id:"sadness_00094.jpg",filename:"sadness_00094.jpg",folder:"sadness",zoomX:784.78,zoomY:664.33},
  {emotion:"sadness",image_id:"sadness_00095.jpg",filename:"sadness_00095.jpg",folder:"sadness",zoomX:848.46,zoomY:496.86},
  {emotion:"sadness",image_id:"sadness_00096.png",filename:"sadness_00096.png",folder:"sadness",zoomX:1093.77,zoomY:577.06},
  {emotion:"sadness",image_id:"sadness_00102.png",filename:"sadness_00102.png",folder:"sadness",zoomX:938.09,zoomY:569.98},
  {emotion:"sadness",image_id:"sadness_00106.png",filename:"sadness_00106.png",folder:"sadness",zoomX:985.27,zoomY:577.06},
  {emotion:"sadness",image_id:"sadness_00108.png",filename:"sadness_00108.png",folder:"sadness",zoomX:1048.95,zoomY:610.08},
  {emotion:"sadness",image_id:"sadness_00111.png",filename:"sadness_00111.png",folder:"sadness",zoomX:1072.54,zoomY:636.03},
  {emotion:"sadness",image_id:"sadness_00112.png",filename:"sadness_00112.png",folder:"sadness",zoomX:1096.13,zoomY:569.98},
  {emotion:"sadness",image_id:"sadness_00113.png",filename:"sadness_00113.png",folder:"sadness",zoomX:902.71,zoomY:496.86},
  {emotion:"sadness",image_id:"sadness_00117.png",filename:"sadness_00117.png",folder:"sadness",zoomX:756.47,zoomY:621.88},
  {emotion:"sadness",image_id:"sadness_00132.png",filename:"sadness_00132.png",folder:"sadness",zoomX:1004.14,zoomY:569.98},
  {emotion:"sadness",image_id:"sadness_00142.png",filename:"sadness_00142.png",folder:"sadness",zoomX:1096.13,zoomY:699.71},
  {emotion:"hope",image_id:"hope_00002.jpg",filename:"hope_00002.jpg",folder:"hope",zoomX:945.17,zoomY:598.29},
  {emotion:"hope",image_id:"hope_00002.png",filename:"hope_00002.png",folder:"hope",zoomX:1091.41,zoomY:487.43},
  {emotion:"hope",image_id:"hope_00004.jpeg",filename:"hope_00004.jpeg",folder:"hope",zoomX:952.24,zoomY:362.42},
  {emotion:"hope",image_id:"hope_00009.jpg",filename:"hope_00009.jpg",folder:"hope",zoomX:907.43,zoomY:386.0},
  {emotion:"hope",image_id:"hope_00012.png",filename:"hope_00012.png",folder:"hope",zoomX:1051.31,zoomY:518.09},
  {emotion:"hope",image_id:"hope_00014.jpg",filename:"hope_00014.jpg",folder:"hope",zoomX:747.04,zoomY:647.82},
  {emotion:"hope",image_id:"hope_00016.jpg",filename:"hope_00016.jpg",folder:"hope",zoomX:798.93,zoomY:433.18},
  {emotion:"hope",image_id:"hope_00016.png",filename:"hope_00016.png",folder:"hope",zoomX:1020.65,zoomY:475.64},
  {emotion:"hope",image_id:"hope_00017.jpg",filename:"hope_00017.jpg",folder:"hope",zoomX:890.92,zoomY:480.35},
  {emotion:"hope",image_id:"hope_00019.jpg",filename:"hope_00019.jpg",folder:"hope",zoomX:978.19,zoomY:640.75},
  {emotion:"hope",image_id:"hope_00019.png",filename:"hope_00019.png",folder:"hope",zoomX:1058.39,zoomY:371.85},
  {emotion:"hope",image_id:"hope_00026.jpg",filename:"hope_00026.jpg",folder:"hope",zoomX:952.24,zoomY:532.24},
  {emotion:"hope",image_id:"hope_00041.png",filename:"hope_00041.png",folder:"hope",zoomX:961.68,zoomY:532.24},
  {emotion:"hope",image_id:"hope_00044.jpg",filename:"hope_00044.jpg",folder:"hope",zoomX:765.91,zoomY:737.45},
  {emotion:"hope",image_id:"hope_00050.png",filename:"hope_00050.png",folder:"hope",zoomX:949.89,zoomY:437.9},
  {emotion:"hope",image_id:"hope_00051.jpg",filename:"hope_00051.jpg",folder:"hope",zoomX:1145.66,zoomY:522.81},
  {emotion:"hope",image_id:"hope_00053.jpg",filename:"hope_00053.jpg",folder:"hope",zoomX:1178.68,zoomY:558.19},
  {emotion:"hope",image_id:"hope_00059.jpg",filename:"hope_00059.jpg",folder:"hope",zoomX:782.42,zoomY:463.84},
  {emotion:"hope",image_id:"hope_00062.png",filename:"hope_00062.png",folder:"hope",zoomX:1048.95,zoomY:437.9},
  {emotion:"hope",image_id:"hope_00063.jpg",filename:"hope_00063.jpg",folder:"hope",zoomX:732.88,zoomY:607.72},
  {emotion:"hope",image_id:"hope_00063.png",filename:"hope_00063.png",folder:"hope",zoomX:905.07,zoomY:430.82},
  {emotion:"hope",image_id:"hope_00064.jpg",filename:"hope_00064.jpg",folder:"hope",zoomX:1037.16,zoomY:423.74},
  {emotion:"hope",image_id:"hope_00073.jpg",filename:"hope_00073.jpg",folder:"hope",zoomX:1006.5,zoomY:444.97},
  {emotion:"hope",image_id:"hope_00075.jpg",filename:"hope_00075.jpg",folder:"hope",zoomX:959.32,zoomY:494.5},
  {emotion:"hope",image_id:"hope_00076.jpg",filename:"hope_00076.jpg",folder:"hope",zoomX:721.09,zoomY:480.35},
  {emotion:"hope",image_id:"hope_00077.jpg",filename:"hope_00077.jpg",folder:"hope",zoomX:796.57,zoomY:565.27},
  {emotion:"hope",image_id:"hope_00078.jpg",filename:"hope_00078.jpg",folder:"hope",zoomX:1091.41,zoomY:437.9},
  {emotion:"hope",image_id:"hope_00081.jpg",filename:"hope_00081.jpg",folder:"hope",zoomX:1048.95,zoomY:565.27},
  {emotion:"hope",image_id:"hope_00083.jpg",filename:"hope_00083.jpg",folder:"hope",zoomX:975.83,zoomY:555.83},
  {emotion:"hope",image_id:"hope_00084.jpg",filename:"hope_00084.jpg",folder:"hope",zoomX:770.62,zoomY:364.78},
  {emotion:"hope",image_id:"hope_00087.jpg",filename:"hope_00087.jpg",folder:"hope",zoomX:1079.62,zoomY:452.05},
  {emotion:"hope",image_id:"hope_00094.png",filename:"hope_00094.png",folder:"hope",zoomX:1051.31,zoomY:480.35},
  {emotion:"hope",image_id:"hope_00112.png",filename:"hope_00112.png",folder:"hope",zoomX:968.76,zoomY:529.89},
  {emotion:"hope",image_id:"hope_00115.png",filename:"hope_00115.png",folder:"hope",zoomX:1074.9,zoomY:518.09},
  {emotion:"hope",image_id:"hope_00117.jpg",filename:"hope_00117.jpg",folder:"hope",zoomX:1067.82,zoomY:456.77},
  {emotion:"hope",image_id:"hope_00118.jpg",filename:"hope_00118.jpg",folder:"hope",zoomX:839.03,zoomY:428.46},
  {emotion:"hope",image_id:"hope_00121.jpg",filename:"hope_00121.jpg",folder:"hope",zoomX:1148.02,zoomY:588.85},
  {emotion:"hope",image_id:"hope_00127.jpg",filename:"hope_00127.jpg",folder:"hope",zoomX:1251.8,zoomY:511.02},
  {emotion:"hope",image_id:"hope_00133.jpg",filename:"hope_00133.jpg",folder:"hope",zoomX:1015.93,zoomY:673.77},
  {emotion:"hope",image_id:"hope_00150.jpeg",filename:"hope_00150.jpeg",folder:"hope",zoomX:914.5,zoomY:565.27},
];

/* ==========================================================================
   SECTION 3 — UTILITAIRES
   ========================================================================== */

/** Retourne l'image en cache navigateur (après préchargement jsPsych) */
function getCachedImage(src) {
  const img = new Image();
  img.src = src;   // instantané depuis le cache navigateur
  return img;
}

/** Dessine une image centrée sur canvas, maintenant le ratio */
function drawImageCentered(canvas, imgSrc) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = CFG.BG_COLOR;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const img = getCachedImage(imgSrc);
  const go = () => {
    const scale = Math.min(canvas.width / img.naturalWidth, canvas.height / img.naturalHeight);
    const dw = img.naturalWidth  * scale;
    const dh = img.naturalHeight * scale;
    const dx = (canvas.width  - dw) / 2;
    const dy = (canvas.height - dh) / 2;
    ctx.drawImage(img, dx, dy, dw, dh);
  };
  if (img.complete && img.naturalWidth) { go(); }
  else { img.onload = go; }
}

/** Dessine l'image zoomée (même logique que MATLAB showZoomedTexture) */
function drawImageZoomed(canvas, imgSrc, zoomX, zoomY) {
  const ctx  = canvas.getContext('2d');
  const zf   = CFG.ZOOM_FACTOR;
  ctx.fillStyle = CFG.BG_COLOR;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const img = getCachedImage(imgSrc);
  const go = () => {
    const IW = img.naturalWidth, IH = img.naturalHeight;
    const srcW = IW / zf, srcH = IH / zf;
    let srcX = zoomX - srcW / 2;
    let srcY = zoomY - srcH / 2;
    // Clamp aux bords de l'image
    srcX = Math.max(0, Math.min(srcX, IW - srcW));
    srcY = Math.max(0, Math.min(srcY, IH - srcH));
    ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, canvas.width, canvas.height);
  };
  if (img.complete && img.naturalWidth) { go(); }
  else { img.onload = go; }
}

/** Fisher-Yates shuffle */
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/** Sélectionne un élément aléatoire d'un tableau */
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* ==========================================================================
   SECTION 4 — CONSTRUCTEURS DE TRIALS
   ========================================================================== */

/* ---- Définitions des émotions ---- */
const EMOTION_DEFS = [
  { name: 'joie',      label: 'JOIE' },
  { name: 'colere',    label: 'COLÈRE' },
  { name: 'espoir',    label: 'ESPOIR' },
  { name: 'tristesse', label: 'TRISTESSE' },
  { name: 'peur',      label: 'PEUR' },
  { name: 'autre',     label: 'AUTRE' },
];

/* ---- Définitions des questions Situation ---- */
const SIT_DEFS = [
  {
    name  : 'sit_controle',
    text  : 'Dans quelle mesure pourriez-vous influencer ce qui s\'y passe ?',
    left  : 'Je n\'aurais aucun contrôle sur la situation',
    right : 'J\'aurais beaucoup de contrôle sur la situation',
  },
  {
    name  : 'sit_aide',
    text  : 'Vous seriez-vous senti(e) aidé(e) ou bloqué(e) dans l\'accomplissement de ce qui est important pour vous ?',
    left  : 'Très bloqué(e)',
    right : 'Très aidé(e)',
  },
  {
    name  : 'sit_consequences',
    text  : 'Dans quelle mesure ce qui s\'y passe aurait-il des conséquences positives ou négatives pour ce qui est important pour vous ?',
    left  : 'Conséquences très négatives',
    right : 'Conséquences très positives',
  },
];

/* ---- Fixation ---- */
function makeFixation() {
  return {
    type    : jsPsychHtmlKeyboardResponse,
    stimulus: '<div class="fixation">+</div>',
    choices : 'NO_KEYS',
    trial_duration: CFG.FIX_MS,
    data    : { phase: 'fixation' },
  };
}

/* ---- Image normale (canvas centré) ---- */
function makeImageTrial(imgData, trialNum) {
  const src = CFG.IMG_BASE + imgData.folder + '/' + imgData.filename;
  return {
    type        : jsPsychCanvasKeyboardResponse,
    canvas_size : [window.screen.height, window.screen.width],
    stimulus    : (canvas) => drawImageCentered(canvas, src),
    choices     : 'NO_KEYS',
    trial_duration: CFG.IMG_MS,
    data        : {
      phase      : 'image_normal',
      trial_num  : trialNum,
      image_id   : imgData.image_id,
      emotion_type: imgData.emotion,
    },
  };
}

/* ---- Image zoomée (canvas) ---- */
function makeZoomTrial(imgData, trialNum) {
  const src = CFG.IMG_BASE + imgData.folder + '/' + imgData.filename;
  return {
    type        : jsPsychCanvasKeyboardResponse,
    canvas_size : [window.screen.height, window.screen.width],
    stimulus    : (canvas) => drawImageZoomed(canvas, src, imgData.zoomX, imgData.zoomY),
    choices     : 'NO_KEYS',
    trial_duration: CFG.IMG_MS,
    data        : {
      phase      : 'image_zoom',
      trial_num  : trialNum,
      image_id   : imgData.image_id,
      emotion_type: imgData.emotion,
      zoomX      : imgData.zoomX,
      zoomY      : imgData.zoomY,
    },
  };
}

/* ---- Module Émotion (6 sliders, AUTRE toujours dernier) ---- */
function makeEmotionTrial(imgData, trialNum) {
  // L'ordre est recalculé dynamiquement à chaque appel de questions()
  let _order = [];
  return {
    type     : jsPsychSurveySlider,
    preamble : '<p style="color:#fff;font-size:18px;margin-bottom:16px;">' +
               'Pendant que vous regardiez l\'image, dans quelle mesure avez-vous ressenti chacune des émotions suivantes ?</p>',
    questions: function() {
      // Shuffle JOIE..PEUR (indices 0-4), AUTRE (indice 5) toujours dernier
      const coreShuf = shuffle([0,1,2,3,4]);
      _order = [...coreShuf, 5];
      return _order.map(i => ({
        prompt       : `<span style="color:#fff;font-size:17px;font-weight:bold">${EMOTION_DEFS[i].label}</span>`,
        labels       : ['Pas du tout','','','','','Extrêmement'],
        min          : 0,
        max          : 100,
        step         : 1,
        start        : 0,
        name         : EMOTION_DEFS[i].name,
        slider_width : 600,
      }));
    },
    require_movement: true,
    button_label    : 'Continuer',
    on_finish : function(data) {
      data.phase       = 'emotion';
      data.trial_num   = trialNum;
      data.image_id    = imgData.image_id;
      data.emotion_type= imgData.emotion;
      data.emotion_order = _order.map(i => EMOTION_DEFS[i].name).join(',');
      // Les réponses sont dans data.response : { joie: val, ... }
    },
  };
}

/* ---- Module DAT (4 dessins + 4 sliders 1-5, grille 2x2) ---- */
function makeDatTrial(imgData, phase, trialNum) {
  // Construit le HTML du formulaire DAT avec dessins et sliders
  function buildDatHtml() {
    const catKeys  = shuffle(['dat1','dat2','dat3','dat4']);  // ordre aléatoire des 4 dim.
    const drawings = catKeys.map(k => randomPick(DAT_DRAWINGS[k]));  // 1 dessin par dim.

    // Stocke pour récupération dans on_finish
    window._datState = { catKeys, drawings };

    const header = phase === 'pre_zoom'
      ? 'Pendant que vous regardiez la dernière image, dans quelle mesure aviez-vous envie d\'agir comme la personne représentée sur chacun de ces dessins ?'
      : 'En vous basant sur votre ÉTAT ACTUEL, dans quelle mesure avez-vous envie d\'agir comme la personne représentée sur chacun de ces dessins ?';

    const cells = drawings.map((src, i) => `
      <div class="dat-cell">
        <img src="${src}" alt="dessin ${i+1}">
        <div class="dat-slider-wrap">
          <input type="range" name="dat_${catKeys[i]}"
                 class="dat-slider required-slider"
                 data-drawing="${src}"
                 min="1" max="5" step="0.1" value="1">
          <div class="dat-tick-labels">
            <span>1<br><small>Pas du tout</small></span>
            <span>3</span>
            <span>5<br><small>Extrêmement</small></span>
          </div>
        </div>
      </div>`).join('');

    return `
      <div id="dat-container">
        <p class="dat-header">${header}</p>
        <p class="dat-subheader">De 1 (pas du tout) à 5 (extrêmement)</p>
        <div class="dat-grid">${cells}</div>
        <div id="dat-error">Merci de déplacer tous les curseurs avant de continuer.</div>
      </div>`;
  }

  return {
    type        : jsPsychSurveyHtmlForm,
    html        : buildDatHtml,
    button_label: 'Continuer',
    on_load     : function() {
      /* Validation : forcer le mouvement de tous les sliders avant soumission */
      const moved = new Set();
      document.querySelectorAll('.required-slider').forEach(s => {
        s.addEventListener('input', () => moved.add(s.name));
      });
      const btn = document.getElementById('jspsych-survey-html-form-next');
      if (btn) {
        btn.addEventListener('click', function(e) {
          if (moved.size < 4) {
            e.preventDefault();
            e.stopImmediatePropagation();
            document.getElementById('dat-error').style.display = 'block';
          }
        }, true);
      }
    },
    on_finish   : function(data) {
      data.phase        = 'dat_' + phase;
      data.trial_num    = trialNum;
      data.image_id     = imgData.image_id;
      data.emotion_type = imgData.emotion;
      // data.response : { dat_dat1: val, dat_dat2: val, ... }
      if (window._datState) {
        data.dat_order    = window._datState.catKeys.join(',');
        data.dat_drawings = window._datState.drawings.join(',');
      }
    },
  };
}

/* ---- Module Situation (3 sliders, ordre aléatoire) ---- */
function makeSituationTrial(imgData, phase, trialNum) {
  let _order = [];
  return {
    type     : jsPsychSurveySlider,
    preamble : '<p style="color:#fff;font-size:18px;margin-bottom:16px;">' +
               'En vous projetant dans la situation représentée par l\'image…</p>',
    questions: function() {
      _order = shuffle([0,1,2]);
      return _order.map(i => ({
        prompt: `<span style="color:#fff;font-size:16px">${SIT_DEFS[i].text}</span>`,
        labels : [SIT_DEFS[i].left,'','','','',SIT_DEFS[i].right],
        min    : 0, max: 100, step: 1, start: 0,
        name   : SIT_DEFS[i].name,
        slider_width: 600,
      }));
    },
    require_movement: true,
    button_label    : 'Continuer',
    on_finish : function(data) {
      data.phase        = 'situation_' + phase;
      data.trial_num    = trialNum;
      data.image_id     = imgData.image_id;
      data.emotion_type = imgData.emotion;
      data.sit_order    = _order.map(i => SIT_DEFS[i].name).join(',');
    },
  };
}

/* ==========================================================================
   SECTION 5 — CONSTRUCTION DE LA TIMELINE
   ========================================================================== */

const jsPsych = initJsPsych({
  on_finish: function() { saveData(); },
});

/* Ordre aléatoire des 80 images (chaque image passée une seule fois) */
const shuffledImages = shuffle(IMAGE_LIST);

/* Toutes les images à précharger */
const allImagePaths = shuffledImages.map(
  d => CFG.IMG_BASE + d.folder + '/' + d.filename
);

/* Liste des dessins DAT à précharger */
const allDatPaths = Object.values(DAT_DRAWINGS).flat();

/* ----- Slide de bienvenue ----- */
const welcome = {
  type    : jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="color:#fff;text-align:center;max-width:700px;margin:auto;font-size:18px;line-height:1.7">
      <h2>Bienvenue</h2>
      <p>Vous allez voir une série d'images.<br>
         Après chaque image, vous répondrez à quelques questions.</p>
      <p>Appuyez sur <strong>ESPACE</strong> pour commencer.</p>
    </div>`,
  choices: [' '],
};

/* ----- Préchargement ----- */
const preload = {
  type  : jsPsychPreload,
  images: [...allImagePaths, ...allDatPaths],
  show_progress_bar: true,
  message: '<p style="color:#fff">Chargement des images…</p>',
};

/* ----- Boucle trials ----- */
const trialTimeline = [];
shuffledImages.forEach((imgData, idx) => {
  const trialNum = idx + 1;

  trialTimeline.push(
    // 1. Fixation 2s
    makeFixation(),
    // 2. Image originale 8s
    makeImageTrial(imgData, trialNum),
    // 3. Émotion (6 sliders, AUTRE toujours dernier)
    makeEmotionTrial(imgData, trialNum),
    // 4. DAT pré-zoom (4 dessins + sliders 1-5)
    makeDatTrial(imgData, 'pre_zoom', trialNum),
    // 5. Situation (3 sliders)
    makeSituationTrial(imgData, 'pre_zoom', trialNum),
    // 6. Fixation 2s
    makeFixation(),
    // 7. Image zoomée 150% (centrée sur zoomX, zoomY) 8s
    makeZoomTrial(imgData, trialNum),
    // 8. DAT post-zoom
    makeDatTrial(imgData, 'post_zoom', trialNum),
    // 9. Situation post-zoom
    makeSituationTrial(imgData, 'post_zoom', trialNum),
  );
});

/* ----- Slide de fin ----- */
const goodbye = {
  type    : jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="color:#fff;text-align:center;font-size:22px">
      <h2>Merci pour votre participation !</h2>
      <p>Vos données ont été sauvegardées.</p>
    </div>`,
  choices         : 'NO_KEYS',
  trial_duration  : 5000,
};

/* ----- Timeline finale ----- */
jsPsych.run([
  preload,
  welcome,
  ...trialTimeline,
  goodbye,
]);

/* ==========================================================================
   SECTION 6 — SAUVEGARDE DES DONNÉES (CSV)
   ========================================================================== */
function saveData() {
  const allData = jsPsych.data.get().filter(
    d => d.phase && d.phase !== 'fixation'
  );

  const rows = allData.values();
  if (!rows.length) return;

  /* Collecte toutes les colonnes présentes */
  const cols = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => cols.add(k)));
  const headers = [...cols];

  const csv = [
    headers.join(','),
    ...rows.map(r =>
      headers.map(h => {
        const v = r[h] !== undefined ? r[h] : '';
        const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
        return '"' + s.replace(/"/g, '""') + '"';
      }).join(',')
    ),
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = 'YC5_data_' + new Date().toISOString().replace(/[:.]/g,'-') + '.csv';
  a.click();
}
</script>
</body>
</html>
